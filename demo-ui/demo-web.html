<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <title>LiveKit æ¸¬è©¦</title>
    <script src="https://cdn.jsdelivr.net/npm/livekit-client@2.11.3/dist/livekit-client.umd.min.js"></script>
  </head>
  <body>
    <h2>LiveKit æ¸¬è©¦é é¢</h2>
    <button id="join">åŠ å…¥æˆ¿é–“</button>
    <div id="video-container"></div>

    <script>
      const wsUrl = "ws://localhost:7880";
      const token =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ2aWRlbyI6eyJyb29tQ3JlYXRlIjp0cnVlLCJyb29tSm9pbiI6dHJ1ZSwicm9vbSI6InRlc3Qtcm9vbSIsImNhblB1Ymxpc2giOnRydWUsImNhblN1YnNjcmliZSI6dHJ1ZSwiY2FuUHVibGlzaERhdGEiOnRydWUsImluZ3Jlc3NBZG1pbiI6dHJ1ZX0sInN1YiI6ImFkbWluLWNsaWVudCIsImlzcyI6ImRldmtleSIsIm5iZiI6MTc1MDgyOTgwMCwiZXhwIjoxNzUwODY1ODAwfQ.tsqgVgvcGzjFkn5zkwkGw5E7_JgIFLx2vThl9AE45AY"; // è«‹è‡ªè¡Œæ›¿æ›

      const room = new LivekitClient.Room();

      // è™•ç†è¨‚é–±å¾Œé¡¯ç¤ºç•«é¢
      function handleTrack(track, publication, participant) {
        console.log(
          `åƒèˆ‡è€… ${participant.identity} çš„è»Œé“å·²è¨‚é–±: ${track.kind}`
        );

        if (track.kind === "video") {
          const videoElement = track.attach();
          videoElement.autoplay = true;
          videoElement.playsInline = true;
          videoElement.style.width = "100%";
          videoElement.style.maxWidth = "300px";
          videoElement.style.border = "1px solid #ccc";

          const container = document.getElementById("video-container");
          if (container) {
            container.appendChild(videoElement);
          }
        }
      }

      document.getElementById("join").onclick = async () => {
        try {
          await room.connect(wsUrl, token);
          console.log("âœ… å·²é€£ç·šè‡³æˆ¿é–“:", room.name);

          // å–å¾—è¨­å‚™
          const devices = await navigator.mediaDevices.enumerateDevices();
          const hasCamera = devices.some((d) => d.kind === "videoinput");
          const hasMic = devices.some((d) => d.kind === "audioinput");

          try {
            if (hasCamera) {
              await room.localParticipant.setCameraEnabled(true);
            }
            if (hasMic) {
              await room.localParticipant.setMicrophoneEnabled(true);
            }
            if (!hasCamera && !hasMic) {
              console.warn("âš ï¸ ç„¡å¯ç”¨çš„æ”å½±æ©Ÿæˆ–éº¥å…‹é¢¨ï¼Œè·³éå•Ÿç”¨åª’é«”ã€‚");
            }
          } catch (err) {
            console.error("âŒ å•Ÿç”¨åª’é«”æ™‚å‡ºéŒ¯:", err);
          }

          // å³æ™‚è¨‚é–±é ç«¯è»Œé“
          room.on(LivekitClient.RoomEvent.TrackSubscribed, handleTrack);

          // ç™¼ç¾é ç«¯ track æ™‚å˜—è©¦è¨‚é–±
          room.on(
            LivekitClient.RoomEvent.TrackPublished,
            async (publication, participant) => {
              console.log(
                `ğŸ” ç™¼ç¾ track: ${publication.kind} from ${participant.identity}`
              );
              if (publication.kind === "video" && !publication.isSubscribed) {
                try {
                  await participant.subscribe(publication);
                } catch (err) {
                  console.error("âŒ æ‰‹å‹•è¨‚é–±å¤±æ•—:", err);
                }
              }
            }
          );

          // æœ‰äººåŠ å…¥æˆ¿é–“
          room.on(
            LivekitClient.RoomEvent.ParticipantConnected,
            (participant) => {
              console.log("ğŸ‘‹ æ–°åƒèˆ‡è€…åŠ å…¥:", participant.identity);
            }
          );
        } catch (error) {
          console.error("âŒ é€£ç·šå¤±æ•—:", error);
        }
      };
    </script>
  </body>
</html>
